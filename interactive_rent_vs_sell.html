<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Rent vs Sell Calculator with Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 15px;
            font-size: 24px;
        }
        .page-title {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .top-section {
            display: grid;
            grid-template-columns: 350px 320px 350px;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            justify-content: center;
        }
        .top-recommendation {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        .main-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chart-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            height: fit-content;
        }
        .control-panel.general {
            border-left: 4px solid #6c757d;
        }
        .control-panel.rental {
            border-left: 4px solid #27ae60;
        }
        .control-panel.selling {
            border-left: 4px solid #3498db;
        }
        .control-section {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        .control-section:last-child {
            border-bottom: none;
        }
        .control-section h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .slider-group {
            margin-bottom: 8px;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-weight: bold;
            color: #34495e;
            font-size: 13px;
        }
        .slider-value {
            color: #3498db;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }
        /* Red slider for year selection */
        #analysisYears::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e74c3c;
            cursor: pointer;
        }
        #analysisYears::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e74c3c;
            cursor: pointer;
            border: none;
        }
        .input-group {
            margin-bottom: 8px;
        }
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            color: #34495e;
            font-size: 13px;
        }
        input[type="number"] {
            width: 100%;
            padding: 6px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            box-sizing: border-box;
        }
        input[type="number"]:focus {
            border-color: #3498db;
            outline: none;
        }
        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 10px;
        }
        .summary-cards {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            align-items: center;
        }
        .chart-only {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        .summary-card {
            background: #ecf0f1;
            padding: 25px 20px;
            border-radius: 10px;
            text-align: center;
            border-top: 5px solid #6c757d;
            min-width: 320px;
        }
        .summary-card.better {
            background: #e8f5e8;
        }
        .summary-card#rentCard {
            border-top-color: #27ae60;
        }
        .summary-card#sellCard {
            border-top-color: #3498db;
        }
        .summary-card#rentCard.better {
            border-top-color: #27ae60;
            background: #e8f5e8;
        }
        .summary-card#sellCard.better {
            border-top-color: #3498db;
            background: #e3f2fd;
        }
        .summary-card h4 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 19px;
        }
        .summary-value {
            font-size: 30px;
            font-weight: bold;
            color: #2c3e50;
        }
        .recommendation {
            background: #3498db;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            max-width: 320px;
            min-width: 300px;
        }
        .recommendation.rent-better { background: #27ae60; }
        .recommendation.sell-better { background: #3498db; }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #3498db;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #2c3e50;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        @media (max-width: 1200px) {
            .controls-grid {
                grid-template-columns: 1fr 1fr;
            }
            .chart-container {
                height: 300px;
            }
        }
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            .summary-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Section with Summary Cards and Recommendation -->
        <div class="top-section">
            <div class="summary-card" id="rentCard">
                <h4>üèòÔ∏è Keep & Rent</h4>
                <div class="summary-value" id="rentTotal">$0</div>
            </div>
            
            <div id="recommendation" class="recommendation">
                <div id="recommendationText"></div>
                <div style="margin-top: 8px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <div class="slider-label" style="color: white; font-size: 11px; margin-bottom: 2px;">
                        <span>üìÖ Analysis Year</span>
                        <span class="slider-value" id="yearsValue" style="color: white;">30 years</span>
                    </div>
                    <input type="range" id="analysisYears" min="1" max="30" step="1" value="30" oninput="updateSlider('years', this.value)" style="width: 100%;">
                </div>
            </div>
            
            <div class="summary-card" id="sellCard">
                <h4>üí∞ Sell & Invest</h4>
                <div class="summary-value" id="sellTotal">$0</div>
            </div>
        </div>
        
        <div class="main-layout">
            <!-- Chart Section -->
            <div class="chart-only">
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- Controls Grid Below -->
            <div class="controls-grid">
                <!-- General Settings -->
                <div class="control-panel general">
                    <h3>üè° General Settings</h3>
                    <div class="input-group">
                        <label for="currentValue">Current Market Value ($)</label>
                        <input type="number" id="currentValue" value="227000" min="0" onchange="updateAppreciationFromValues()">
                    </div>
                    <div class="input-group">
                        <label for="originalPurchase">Original Purchase Price ($)</label>
                        <input type="number" id="originalPurchase" value="139000" min="0" onchange="updateAppreciationFromValues()">
                    </div>
                    <div class="input-group">
                        <label for="purchaseYear">Purchase Year</label>
                        <input type="number" id="purchaseYear" value="2018" min="1950" max="2025" onchange="updateAppreciationFromValues()">
                    </div>
                    <div class="control-section">
                        <h3>üìà Property Appreciation</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Historical Appreciation <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Calculated from your actual purchase year and current value. This is what already happened.</span>
                                </span></span>
                                <span class="slider-value" id="historicalAppreciationValue">3.5%</span>
                            </div>
                            <input type="range" id="historicalAppreciation" min="0" max="15" step="0.1" value="3.5" disabled style="opacity: 0.6;">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Future Appreciation <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Your projection for future annual appreciation. Consider market conditions, neighborhood trends, and economic outlook.</span>
                                </span></span>
                                <span class="slider-value" id="futureAppreciationValue">3.0%</span>
                            </div>
                            <input type="range" id="futureAppreciation" min="0" max="8" step="0.1" value="3.0" oninput="updateSlider('futureAppreciation', this.value)">
                        </div>
                    </div>
                    <div class="control-section">
                        <h3>üè¶ Mortgage Information</h3>
                        <div class="input-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="hasMortgage" onchange="toggleMortgageFields()" style="transform: scale(1.2);">
                                <span>Property has existing mortgage</span>
                            </label>
                        </div>
                        <div id="mortgageFields" style="display: none;">
                            <div class="input-group">
                                <label for="remainingBalance">Remaining Mortgage Balance ($)</label>
                                <input type="number" id="remainingBalance" value="0" min="0" onchange="updateCalculation()">
                            </div>
                            <div class="input-group">
                                <label for="monthlyPayment">Monthly Mortgage Payment ($)</label>
                                <input type="number" id="monthlyPayment" value="0" min="0" onchange="updateCalculation()">
                            </div>
                            <div class="input-group">
                                <label for="mortgageRate">Mortgage Interest Rate (%)</label>
                                <input type="number" id="mortgageRate" value="6.5" min="0" max="15" step="0.1" onchange="updateCalculation()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rental Scenario Settings -->
                <div class="control-panel rental">
                    <h3>üèòÔ∏è Rental Scenario</h3>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Monthly Rent</span>
                            <span class="slider-value" id="rentValue">$1,400</span>
                        </div>
                        <input type="range" id="monthlyRent" min="1000" max="4000" step="50" value="1400" oninput="updateSlider('rent', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Rent Growth (Annual)</span>
                            <span class="slider-value" id="rentGrowthValue">3%</span>
                        </div>
                        <input type="range" id="rentGrowth" min="0" max="6" step="0.1" value="3" oninput="updateSlider('rentGrowth', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>HOA Fees (Monthly)</span>
                            <span class="slider-value" id="hoaValue">$0</span>
                        </div>
                        <input type="range" id="hoaFees" min="0" max="800" step="25" value="0" oninput="updateSlider('hoa', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Maintenance (Monthly)</span>
                            <span class="slider-value" id="maintenanceValue">$0</span>
                        </div>
                        <input type="range" id="maintenance" min="0" max="1000" step="50" value="0" oninput="updateSlider('maintenance', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Property Mgmt (%)</span>
                            <span class="slider-value" id="propMgmtValue">0.0%</span>
                        </div>
                        <input type="range" id="propManagement" min="0" max="15" step="0.5" value="0" oninput="updateSlider('propMgmt', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Property Taxes (Annual)</span>
                            <span class="slider-value" id="taxesValue">$3,200</span>
                        </div>
                        <input type="range" id="propertyTaxes" min="1000" max="8000" step="100" value="3200" oninput="updateSlider('taxes', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Insurance (Annual)</span>
                            <span class="slider-value" id="insuranceValue">$1,700</span>
                        </div>
                        <input type="range" id="insurance" min="500" max="3000" step="50" value="1700" oninput="updateSlider('insurance', this.value)">
                    </div>
                    <div class="control-section">
                        <h3>üìä Tax Calculations</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Marginal Tax Rate <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Your highest tax bracket rate. Common federal rates: 22% ($47K-$100K), 24% ($100K-$191K), 32% ($191K-$243K). Add ~3-5% for state taxes if applicable.</span>
                                </span></span>
                                <span class="slider-value" id="marginalTaxValue">24%</span>
                            </div>
                            <input type="range" id="marginalTaxRate" min="0" max="37" step="1" value="24" oninput="updateSlider('marginalTax', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="depreciationBasis">Depreciation Basis ($) <span class="tooltip">‚ÑπÔ∏è
                                <span class="tooltiptext">Usually your current property value. This amount √∑ 27.5 years = annual depreciation deduction. For $175K property = $6,364/year tax deduction.</span>
                            </span></label>
                            <input type="number" id="depreciationBasis" value="175000" min="0" onchange="updateCalculation()" placeholder="Auto-updates with current value">
                        </div>
                    </div>
                </div>

                <!-- Selling Scenario Settings -->
                <div class="control-panel selling">
                    <h3>üí∞ Selling Scenario</h3>
                    
                    <div class="control-section">
                        <h3>üè† Pre-Sale Costs</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Repairs & Staging <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Typical costs: $2K-$15K for repairs, painting, cleaning, staging to maximize sale price.</span>
                                </span></span>
                                <span class="slider-value" id="repairsValue">$5,000</span>
                            </div>
                            <input type="range" id="repairsCosts" min="0" max="25000" step="500" value="5000" oninput="updateSlider('repairs', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Home Inspection <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Pre-listing inspection to identify issues early. Typical cost: $300-$600.</span>
                                </span></span>
                                <span class="slider-value" id="inspectionValue">$450</span>
                            </div>
                            <input type="range" id="inspectionCosts" min="0" max="1000" step="50" value="450" oninput="updateSlider('inspection', this.value)">
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h3>üèòÔ∏è Transaction Costs</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Real Estate Commission <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Typically 5-6% total (2.5-3% each for buyer's and seller's agents). Negotiate for lower rates.</span>
                                </span></span>
                                <span class="slider-value" id="commissionValue">5.5%</span>
                            </div>
                            <input type="range" id="realtorCommission" min="0" max="8" step="0.1" value="5.5" oninput="updateSlider('commission', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Title & Closing Costs <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Title insurance, attorney fees, transfer taxes, recording fees. Usually 1-2% of sale price.</span>
                                </span></span>
                                <span class="slider-value" id="closingValue">1.5%</span>
                            </div>
                            <input type="range" id="closingCosts" min="0.5" max="3" step="0.1" value="1.5" oninput="updateSlider('closing', this.value)">
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h3>üìä Taxes & Investment</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Capital Gains Tax <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Real estate: 0% (primary residence), 15% (most people), 20% (high income), 25% (depreciation recapture). Add 3-13% state taxes.</span>
                                </span></span>
                                <span class="slider-value" id="capitalGainsValue">15%</span>
                            </div>
                            <input type="range" id="capitalGainsRate" min="0" max="35" step="1" value="15" oninput="updateSlider('capitalGains', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Investment Return (Annual) <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">S&P 500 historical: 10-11%. Conservative: 6-7%. Aggressive: 8-10%. Consider fees, taxes, and volatility.</span>
                                </span></span>
                                <span class="slider-value" id="investmentValue">7.5%</span>
                            </div>
                            <input type="range" id="investmentReturn" min="4" max="12" step="0.1" value="7.5" oninput="updateSlider('investment', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Investment Tax Rate <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Tax on investment gains/dividends. 0% (low income), 15% (most people), 20% (high income). Consider tax-advantaged accounts.</span>
                                </span></span>
                                <span class="slider-value" id="investmentTaxValue">15%</span>
                            </div>
                            <input type="range" id="investmentTaxRate" min="0" max="25" step="1" value="15" oninput="updateSlider('investmentTax', this.value)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mortgage Payment Calculator -->
    <div class="container" style="margin-top: 20px;">
        <h2 style="color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 20px;">üè¶ Mortgage Payment Calculator</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;">
            <!-- Input Section -->
            <div class="control-panel" style="border-left: 4px solid #e67e22;">
                <h3>üí∞ Loan Details</h3>
                <div class="input-group">
                    <label for="loanAmount">Loan Amount ($)</label>
                    <input type="number" id="loanAmount" value="140000" min="0" onchange="calculateMortgage()" placeholder="Amount to borrow">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Interest Rate (Annual)</span>
                        <span class="slider-value" id="mortgageInterestValue">6.5%</span>
                    </div>
                    <input type="range" id="mortgageInterestRate" min="2" max="10" step="0.1" value="6.5" oninput="updateMortgageSlider('mortgageInterest', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Loan Term</span>
                        <span class="slider-value" id="loanTermValue">30 years</span>
                    </div>
                    <input type="range" id="loanTerm" min="10" max="30" step="5" value="30" oninput="updateMortgageSlider('loanTerm', this.value)">
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="control-panel" style="border-left: 4px solid #27ae60;">
                <h3>üìä Payment Breakdown</h3>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold;">Monthly Payment:</span>
                        <span id="monthlyPaymentResult" style="font-size: 18px; font-weight: bold; color: #2c3e50;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Principal & Interest:</span>
                        <span id="principalInterestResult" style="color: #2c3e50;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Total Interest Paid:</span>
                        <span id="totalInterestResult" style="color: #e74c3c;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Total Amount Paid:</span>
                        <span id="totalAmountResult" style="color: #2c3e50;">$0</span>
                    </div>
                </div>
                <button onclick="copyToMortgageFields()" style="width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    üìã Copy to Mortgage Fields Above
                </button>
            </div>
        </div>
    </div>

    <script>
        let chart;
        
        function calculateAppreciationRate() {
            const currentValue = parseFloat(document.getElementById('currentValue').value) || 0;
            const originalPurchase = parseFloat(document.getElementById('originalPurchase').value) || 0;
            const purchaseYear = parseInt(document.getElementById('purchaseYear').value) || 2005;
            
            if (currentValue <= 0 || originalPurchase <= 0 || currentValue <= originalPurchase) {
                return 3.5; // Default fallback
            }
            
            // Calculate years owned from purchase year to current year (2025)
            const currentYear = 2025;
            const yearsOwned = currentYear - purchaseYear;
            
            if (yearsOwned <= 0) {
                return 3.5; // Fallback for invalid years
            }
            
            // Calculate compound annual growth rate (CAGR)
            const appreciationRate = (Math.pow(currentValue / originalPurchase, 1 / yearsOwned) - 1) * 100;
            
            // Cap between reasonable bounds (0-8%)
            return Math.min(Math.max(appreciationRate, 0), 8);
        }
        
        function updateAppreciationFromValues() {
            const calculatedRate = calculateAppreciationRate();
            const roundedRate = Math.round(calculatedRate * 10) / 10; // Round to 1 decimal
            const currentValue = parseFloat(document.getElementById('currentValue').value) || 0;
            
            // Update historical appreciation (calculated, read-only)
            document.getElementById('historicalAppreciation').value = roundedRate;
            document.getElementById('historicalAppreciationValue').textContent = roundedRate.toFixed(1) + '%';
            
            // Update depreciation basis to current market value
            document.getElementById('depreciationBasis').value = currentValue;
            
            updateCalculation();
        }
        
        function toggleMortgageFields() {
            const hasMortgage = document.getElementById('hasMortgage').checked;
            const mortgageFields = document.getElementById('mortgageFields');
            
            if (hasMortgage) {
                mortgageFields.style.display = 'block';
            } else {
                mortgageFields.style.display = 'none';
            }
            
            updateCalculation();
        }
        
        // Mortgage Calculator Functions
        function updateMortgageSlider(type, value) {
            switch(type) {
                case 'mortgageInterest':
                    document.getElementById('mortgageInterestValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'loanTerm':
                    document.getElementById('loanTermValue').textContent = parseInt(value) + ' years';
                    break;
            }
            calculateMortgage();
        }
        
        function calculateMortgage() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const annualRate = parseFloat(document.getElementById('mortgageInterestRate').value) || 0;
            const loanTermYears = parseInt(document.getElementById('loanTerm').value) || 30;
            
            if (loanAmount <= 0 || annualRate <= 0) {
                document.getElementById('monthlyPaymentResult').textContent = '$0';
                document.getElementById('principalInterestResult').textContent = '$0';
                document.getElementById('totalInterestResult').textContent = '$0';
                document.getElementById('totalAmountResult').textContent = '$0';
                return;
            }
            
            // Calculate monthly payment using standard mortgage formula
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = loanTermYears * 12;
            
            const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                 (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            const totalAmount = monthlyPayment * numPayments;
            const totalInterest = totalAmount - loanAmount;
            
            // Update display
            document.getElementById('monthlyPaymentResult').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
            document.getElementById('principalInterestResult').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
            document.getElementById('totalInterestResult').textContent = '$' + Math.round(totalInterest).toLocaleString();
            document.getElementById('totalAmountResult').textContent = '$' + Math.round(totalAmount).toLocaleString();
        }
        
        function copyToMortgageFields() {
            const monthlyPayment = parseFloat(document.getElementById('monthlyPaymentResult').textContent.replace(/[$,]/g, '')) || 0;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const interestRate = parseFloat(document.getElementById('mortgageInterestRate').value) || 0;
            
            // Copy to mortgage fields in main calculator
            document.getElementById('remainingBalance').value = loanAmount;
            document.getElementById('monthlyPayment').value = monthlyPayment;
            document.getElementById('mortgageRate').value = interestRate;
            
            // Enable mortgage checkbox
            document.getElementById('hasMortgage').checked = true;
            toggleMortgageFields();
            
            // Show confirmation
            alert('‚úÖ Mortgage details copied to calculator above!');
        }
        
        function updateSlider(type, value) {
            switch(type) {
                case 'appreciation':
                    document.getElementById('appreciationValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'futureAppreciation':
                    document.getElementById('futureAppreciationValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'rent':
                    document.getElementById('rentValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'investment':
                    document.getElementById('investmentValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'rentGrowth':
                    document.getElementById('rentGrowthValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'hoa':
                    document.getElementById('hoaValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'maintenance':
                    document.getElementById('maintenanceValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'propMgmt':
                    document.getElementById('propMgmtValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'taxes':
                    document.getElementById('taxesValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'insurance':
                    document.getElementById('insuranceValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'years':
                    document.getElementById('yearsValue').textContent = parseInt(value) + ' years';
                    break;
                case 'marginalTax':
                    document.getElementById('marginalTaxValue').textContent = parseInt(value) + '%';
                    break;
                case 'repairs':
                    document.getElementById('repairsValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'inspection':
                    document.getElementById('inspectionValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'commission':
                    document.getElementById('commissionValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'closing':
                    document.getElementById('closingValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'investmentTax':
                    document.getElementById('investmentTaxValue').textContent = parseInt(value) + '%';
                    break;
                case 'capitalGains':
                    document.getElementById('capitalGainsValue').textContent = parseInt(value) + '%';
                    break;
            }
            updateCalculation();
        }
        
        function analyzeCrossovers(rentValues, sellValues) {
            const crossovers = [];
            let currentBetter = rentValues[0] > sellValues[0] ? 'rent' : 'sell';
            let segmentStart = 1;
            
            // Find all crossover points
            for (let i = 1; i < rentValues.length; i++) {
                const rentBetter = rentValues[i] > sellValues[i];
                const newBetter = rentBetter ? 'rent' : 'sell';
                
                if (newBetter !== currentBetter) {
                    // Crossover detected
                    crossovers.push({
                        better: currentBetter,
                        startYear: segmentStart,
                        endYear: i,
                        duration: i - segmentStart + 1
                    });
                    currentBetter = newBetter;
                    segmentStart = i + 1;
                }
            }
            
            // Add final segment
            crossovers.push({
                better: currentBetter,
                startYear: segmentStart,
                endYear: 30,
                duration: 30 - segmentStart + 1
            });
            
            // Generate recommendation text
            const finalRentValue = rentValues[rentValues.length - 1];
            const finalSellValue = sellValues[sellValues.length - 1];
            const finalDifference = Math.abs(finalRentValue - finalSellValue);
            const finalBetter = finalRentValue > finalSellValue ? 'RENT' : 'SELL';
            
            if (crossovers.length === 1) {
                // No crossovers - one strategy is always better
                const strategy = crossovers[0].better.toUpperCase();
                return `
                    üéØ RECOMMENDATION: ${strategy}<br>
                    ${strategy === 'RENT' ? 'Renting' : 'Selling'} is consistently better throughout all 30 years<br>
                    Final advantage: $${Math.round(finalDifference).toLocaleString()}
                `;
            } else {
                // Has crossovers - explain the pattern
                let explanation = `üéØ STRATEGY: `;
                
                if (crossovers.length === 2) {
                    const first = crossovers[0];
                    const second = crossovers[1];
                    if (first.better === 'rent') {
                        explanation += `RENT is better for ${first.duration} year${first.duration > 1 ? 's' : ''}, then SELL becomes better<br>`;
                    } else {
                        explanation += `SELL is better for ${first.duration} year${first.duration > 1 ? 's' : ''}, then RENT becomes better<br>`;
                    }
                    explanation += `Crossover at year ${second.startYear}. Final: ${finalBetter} by $${Math.round(finalDifference).toLocaleString()}`;
                } else {
                    // Multiple crossovers
                    explanation += `Multiple crossovers detected<br>`;
                    const segments = crossovers.slice(0, 2).map(seg => 
                        `${seg.better.toUpperCase()} (yrs ${seg.startYear}-${seg.endYear})`
                    ).join(', then ');
                    explanation += `${segments}...<br>Final: ${finalBetter} by $${Math.round(finalDifference).toLocaleString()}`;
                }
                
                return explanation;
            }
        }
        
        function updateCalculation() {
            // Get all values
            const currentValue = parseFloat(document.getElementById('currentValue').value) || 0;
            const originalPurchase = parseFloat(document.getElementById('originalPurchase').value) || 0;
            const futureAppreciation = parseFloat(document.getElementById('futureAppreciation').value) || 0;
            const monthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 0;
            const investmentReturn = parseFloat(document.getElementById('investmentReturn').value) || 0;
            const rentGrowth = parseFloat(document.getElementById('rentGrowth').value) || 0;
            const hoaFees = parseFloat(document.getElementById('hoaFees').value) || 0;
            const maintenance = parseFloat(document.getElementById('maintenance').value) || 0;
            const propManagement = parseFloat(document.getElementById('propManagement').value) || 0;
            const propertyTaxes = parseFloat(document.getElementById('propertyTaxes').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const capitalGainsRate = parseFloat(document.getElementById('capitalGainsRate').value) || 0;
            const marginalTaxRate = parseFloat(document.getElementById('marginalTaxRate').value) || 0;
            const depreciationBasis = parseFloat(document.getElementById('depreciationBasis').value) || currentValue;
            const selectedYear = parseInt(document.getElementById('analysisYears').value) || 30; // Selected year for display
            
            // New detailed selling costs
            const repairsCosts = parseFloat(document.getElementById('repairsCosts').value) || 0;
            const inspectionCosts = parseFloat(document.getElementById('inspectionCosts').value) || 0;
            const realtorCommission = parseFloat(document.getElementById('realtorCommission').value) || 0;
            const closingCosts = parseFloat(document.getElementById('closingCosts').value) || 0;
            const investmentTaxRate = parseFloat(document.getElementById('investmentTaxRate').value) || 0;
            
            // Mortgage variables
            const hasMortgage = document.getElementById('hasMortgage').checked;
            const remainingBalance = parseFloat(document.getElementById('remainingBalance').value) || 0;
            const monthlyPayment = parseFloat(document.getElementById('monthlyPayment').value) || 0;
            const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) || 0;
            
            // Calculate selling scenario
            const commissionCosts = currentValue * (realtorCommission / 100);
            const titleClosingCosts = currentValue * (closingCosts / 100);
            const totalSellingCosts = repairsCosts + inspectionCosts + commissionCosts + titleClosingCosts;
            const capitalGain = Math.max(0, currentValue - originalPurchase);
            const capitalGainsTax = capitalGain * (capitalGainsRate / 100);
            
            // Net proceeds after paying off mortgage (if any)
            const mortgagePayoff = hasMortgage ? remainingBalance : 0;
            const netProceeds = currentValue - totalSellingCosts - capitalGainsTax - mortgagePayoff;
            
            // Calculate projections for full 30 years (for chart)
            const years = Array.from({length: 30}, (_, i) => i + 1);
            const rentValues = [];
            const sellValues = [];

            for (let year = 1; year <= 30; year++) {
                // Rental scenario - future property value based on projected appreciation
                const futureValue = currentValue * Math.pow(1 + futureAppreciation / 100, year);
                
                // Calculate cumulative cash flow properly - sum of each year's net cash flow
                let cumulativeCashFlow = 0;
                const annualDepreciation = depreciationBasis / 27.5; // Residential rental depreciation
                
                for (let y = 1; y <= year; y++) {
                    const yearRent = monthlyRent * Math.pow(1 + rentGrowth / 100, y);
                    const yearPropMgmt = yearRent * (propManagement / 100);
                    const monthlyTaxes = propertyTaxes / 12;
                    const monthlyInsurance = insurance / 12;
                    const monthlyMortgage = hasMortgage ? monthlyPayment : 0;
                    const monthlyExpenses = hoaFees + maintenance + yearPropMgmt + monthlyTaxes + monthlyInsurance + monthlyMortgage;
                    const monthlyNet = yearRent - monthlyExpenses;
                    const yearlyNet = monthlyNet * 12;
                    
                    // Calculate rental income taxes (mortgage interest is deductible)
                    let mortgageInterestDeduction = 0;
                    if (hasMortgage && remainingBalance > 0) {
                        // Approximate mortgage interest for the year (simplified calculation)
                        mortgageInterestDeduction = remainingBalance * (mortgageRate / 100);
                    }
                    
                    const totalDeductibleExpenses = (hoaFees + maintenance + yearPropMgmt) * 12 + propertyTaxes + insurance + mortgageInterestDeduction;
                    const taxableIncome = Math.max(0, (yearRent * 12) - totalDeductibleExpenses - annualDepreciation);
                    const incomeTax = taxableIncome * (marginalTaxRate / 100);
                    
                    // Net cash flow after income taxes
                    const afterTaxNet = yearlyNet - incomeTax;
                    cumulativeCashFlow += afterTaxNet;
                }
                
                // Total rental value = property value + cash you've actually collected
                // This represents your total net worth from keeping the property
                const totalRentalValue = futureValue + cumulativeCashFlow;
                
                // Sell scenario - what your investment would be worth (after taxes)
                const grossInvestmentValue = netProceeds * Math.pow(1 + investmentReturn / 100, year);
                const investmentGain = grossInvestmentValue - netProceeds;
                const investmentTax = investmentGain * (investmentTaxRate / 100);
                const investmentValue = grossInvestmentValue - investmentTax;
                
                rentValues.push(totalRentalValue);
                sellValues.push(investmentValue);
            }
            
            // Update chart with full 30-year data but highlight selected year
            updateChart(years, rentValues, sellValues, selectedYear);
            
            // Update summary cards with selected year values
            const selectedRentValue = rentValues[selectedYear - 1];
            const selectedSellValue = sellValues[selectedYear - 1];
            const rentBetter = selectedRentValue > selectedSellValue;
            
            document.getElementById('rentTotal').textContent = '$' + Math.round(selectedRentValue).toLocaleString();
            document.getElementById('sellTotal').textContent = '$' + Math.round(selectedSellValue).toLocaleString();
            
            // Update card styling based on selected year
            if (rentBetter) {
                document.getElementById('rentCard').classList.add('better');
                document.getElementById('sellCard').classList.remove('better');
            } else {
                document.getElementById('sellCard').classList.add('better');
                document.getElementById('rentCard').classList.remove('better');
            }
            
            // Analyze crossover patterns for full 30 years
            const crossoverAnalysis = analyzeCrossovers(rentValues, sellValues);
            
            // Update recommendation with selected year context
            const difference = Math.abs(selectedRentValue - selectedSellValue);
            const recommendationEl = document.getElementById('recommendationText');
            const recommendationContainer = document.getElementById('recommendation');
            const betterOption = rentBetter ? 'RENT' : 'SELL';
            const recommendationClass = rentBetter ? 'rent-better' : 'sell-better';
            
            recommendationContainer.className = `recommendation ${recommendationClass}`;
            
            // Show selected year summary plus crossover analysis
            const yearSummary = `
                üéØ YEAR ${selectedYear}: ${betterOption}<br>
                Better by $${Math.round(difference).toLocaleString()}<br>
                <small style="opacity: 0.9;">${crossoverAnalysis.replace('üéØ STRATEGY: ', '').replace('üéØ RECOMMENDATION: ', '')}</small>
            `;
            
            recommendationEl.innerHTML = yearSummary;
        }
        
        function updateChart(years, rentValues, sellValues, highlightYear = 30) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Keep & Rent',
                        data: rentValues,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: years.map((year, index) => year === highlightYear ? 6 : 2),
                        pointHoverRadius: 5,
                        pointBackgroundColor: years.map((year, index) => year === highlightYear ? '#e74c3c' : '#27ae60'),
                        pointBorderColor: years.map((year, index) => year === highlightYear ? '#c0392b' : '#27ae60'),
                        pointBorderWidth: years.map((year, index) => year === highlightYear ? 3 : 1)
                    }, {
                        label: 'Sell & Invest',
                        data: sellValues,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: years.map((year, index) => year === highlightYear ? 6 : 2),
                        pointHoverRadius: 5,
                        pointBackgroundColor: years.map((year, index) => year === highlightYear ? '#e74c3c' : '#3498db'),
                        pointBorderColor: years.map((year, index) => year === highlightYear ? '#c0392b' : '#3498db'),
                        pointBorderWidth: years.map((year, index) => year === highlightYear ? 3 : 1)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 13
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                beforeBody: function(tooltipItems) {
                                    const rentValue = tooltipItems.find(item => item.datasetIndex === 0)?.raw || 0;
                                    const sellValue = tooltipItems.find(item => item.datasetIndex === 1)?.raw || 0;
                                    const difference = Math.abs(rentValue - sellValue);
                                    const betterOption = rentValue > sellValue ? 'Rent' : 'Sell';
                                    return `${betterOption} is better by $${Math.round(difference).toLocaleString()}`;
                                },
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return `${label}: $${Math.round(value).toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years'
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                maxTicksLimit: 31, // Show all years 1-30
                                callback: function(value, index) {
                                    // Show every 5th year plus year 1 and 30
                                    const year = this.getLabelForValue(value);
                                    if (year === 1 || year === 30 || year % 5 === 0) {
                                        return year;
                                    }
                                    return '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Value ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        // Initialize on page load
        window.onload = function() {
            updateAppreciationFromValues(); // Calculate and set appreciation rate first
            calculateMortgage(); // Initialize mortgage calculator
        };
    </script>
</body>
</html>